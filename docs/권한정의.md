# Offio 권한 정의

## 역할 구조

```
┌─────────────────────────────────────────────────────────────┐
│                         Admin (관리자)                        │
│                    회사 전체 관리 권한                         │
├─────────────────────────────────────────────────────────────┤
│                        Manager (팀장)                         │
│              자기 부서 관리 + 본인 근무 기록                    │
│              ※ Standard/Enterprise 전용                      │
├─────────────────────────────────────────────────────────────┤
│                        Worker (근무자)                        │
│                     본인 근무 기록만                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 플랜별 역할 지원

| 역할 | Lite | Standard | Enterprise |
|------|:----:|:--------:|:----------:|
| Admin (관리자) | O | O | O |
| Manager (팀장) | X | O | O |
| Worker (근무자) | O | O | O |

> **Lite 요금제**: 관리자-근무자 2단계 구조만 지원

---

## 역할별 기능 권한

### 1. Worker (근무자)

본인의 근무 기록만 관리할 수 있는 기본 역할

#### 메뉴 접근

| 메뉴 | 경로 | 설명 |
|------|------|------|
| 대시보드 | `/home` | 본인 근무 현황 |
| 근무기록 | `/sessions` | 본인 근무 기록 목록 |
| 통계 | `/stats` | 본인 근무 통계 |
| 휴가관리 | `/my-vacations` | 본인 휴가 신청/조회 (Enterprise) |

#### 기능 권한

| 기능 | 권한 | 비고 |
|------|:----:|------|
| 본인 근무 기록 조회 | O | |
| 본인 근무 기록 편집 | O | 제출 전까지 |
| 본인 근무 기록 제출 | O | |
| 타인 근무 기록 조회 | X | |
| 승인/반려 | X | |
| 팀원 관리 | X | |
| 설정 변경 | X | |
| 휴가 신청 | O | Enterprise만 |
| 휴가 승인 | X | |

---

### 2. Manager (팀장)

자기 부서 근무자의 근태를 관리하면서 본인도 근무 기록을 작성하는 역할

> **Standard/Enterprise 전용** - Lite에서는 사용 불가

#### 메뉴 접근

**팀 관리 메뉴:**

| 메뉴 | 경로 | 설명 |
|------|------|------|
| 팀 대시보드 | `/dashboard` | 부서 근무 현황 |
| 승인관리 | `/approvals` | 부서원 근무 승인 |
| 리포트 | `/reports` | 부서 리포트 |

**내 근무 메뉴:**

| 메뉴 | 경로 | 설명 |
|------|------|------|
| 내 대시보드 | `/home` | 본인 근무 현황 |
| 내 근무기록 | `/sessions` | 본인 근무 기록 |
| 내 통계 | `/stats` | 본인 근무 통계 |
| 내 휴가 | `/my-vacations` | 본인 휴가 (Enterprise) |

#### 기능 권한

| 기능 | 권한 | 범위 |
|------|:----:|------|
| 본인 근무 기록 조회 | O | |
| 본인 근무 기록 편집 | O | 제출 전까지 |
| 본인 근무 기록 제출 | O | |
| 부서원 근무 기록 조회 | O | 자기 부서만 |
| 부서원 근무 승인/반려 | O | 자기 부서만 |
| 부서 리포트 조회 | O | 자기 부서만 |
| 타부서 근무 기록 조회 | X | |
| 팀원 추가/삭제 | X | |
| 회사 설정 변경 | X | |
| 휴가 신청 | O | Enterprise만 |
| 부서원 휴가 승인 | O | Enterprise, 자기 부서만 |

---

### 3. Admin (관리자)

회사 전체를 관리하는 최고 권한 역할

#### 메뉴 접근

**기본 메뉴:**

| 메뉴 | 경로 | 설명 |
|------|------|------|
| 대시보드 | `/dashboard` | 회사 전체 현황 |
| 승인관리 | `/approvals` | 전체 근무 승인 |
| 팀원관리 | `/team` | 직원 추가/삭제/수정 |
| 리포트 | `/reports` | 전체 리포트 |
| 설정 | `/settings` | 회사 설정 |

**Enterprise 전용 메뉴:**

| 메뉴 | 경로 | 설명 |
|------|------|------|
| 휴가관리 | `/vacations` | 전체 휴가 관리 |
| 조직관리 | `/organization` | 부서/조직도 관리 |
| 근무정책 | `/policies` | 근무 정책 설정 |
| 고급통계 | `/analytics` | 고급 분석 |

#### 기능 권한

| 기능 | 권한 | 비고 |
|------|:----:|------|
| 전체 근무 기록 조회 | O | 회사 전체 |
| 전체 근무 승인/반려 | O | |
| 팀원 추가/삭제 | O | |
| 팀원 권한 변경 | O | |
| 회사 설정 변경 | O | |
| 리포트 다운로드 | O | |
| 휴가 관리 | O | Enterprise |
| 조직 관리 | O | Enterprise |
| 근무 정책 설정 | O | Enterprise |

> **참고**: 관리자는 본인 근무 기록을 작성하지 않음 (관리 전담)

---

## API 접근 권한

### 세션 API (`/api/sessions`)

| 메서드 | Worker | Manager | Admin |
|--------|:------:|:-------:|:-----:|
| GET (목록) | 본인만 | 본인만 | 회사 전체 |
| GET (상세) | 본인만 | 본인+부서원 | 회사 전체 |
| POST (생성) | 본인만 | 본인만 | X |
| PATCH (수정) | 본인만 | 본인만 | X |
| POST (제출) | 본인만 | 본인만 | X |

### 승인 API (`/api/approvals`)

| 메서드 | Worker | Manager | Admin |
|--------|:------:|:-------:|:-----:|
| GET (대기 목록) | X | 부서원 | 회사 전체 |
| POST (승인) | X | 부서원 | 회사 전체 |
| POST (반려) | X | 부서원 | 회사 전체 |

### 팀원 API (`/api/users`)

| 메서드 | Worker | Manager | Admin |
|--------|:------:|:-------:|:-----:|
| GET (목록) | X | 부서원 | 회사 전체 |
| POST (추가) | X | X | O |
| PATCH (수정) | X | 부서원만 (role 제외) | O |
| DELETE (삭제) | X | X | O |

### 리포트 API (`/api/reports/export`)

| 메서드 | Worker | Manager | Admin |
|--------|:------:|:-------:|:-----:|
| GET (근무기록) | X | 부서원만 | 회사 전체 |
| GET (직원목록) | X | 부서원만 | 회사 전체 |
| GET (휴가내역) | X | 부서원만 | 회사 전체 |

### 휴가 API (`/api/vacations`) - Enterprise

| 메서드 | Worker | Manager | Admin |
|--------|:------:|:-------:|:-----:|
| GET (목록) | 본인만 | 본인+부서원 | 회사 전체 |
| POST (신청) | 본인만 | 본인만 | X |
| POST (승인) | X | 부서원 | 회사 전체 |

---

## 데이터 조회 범위 요약

```
┌─────────────────────────────────────────────────────────────┐
│                          Admin                              │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                   회사 전체 데이터                      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │ │
│  │  │   개발팀    │ │  디자인팀   │ │  마케팅팀   │     │ │
│  │  │  (Manager)  │ │  (Manager)  │ │  (Manager)  │     │ │
│  │  │  Worker A   │ │  Worker C   │ │  Worker E   │     │ │
│  │  │  Worker B   │ │  Worker D   │ │  Worker F   │     │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘     │ │
│  └───────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘

Manager: 자기 부서 데이터만 (본인 포함)
Worker: 본인 데이터만
```

---

## 화면별 권한 체크

### 접근 가능 경로

| 경로 | Worker | Manager | Admin |
|------|:------:|:-------:|:-----:|
| `/home` | O | O | X |
| `/sessions` | O | O | X |
| `/sessions/[id]` | 본인만 | 본인+부서원 | 회사 전체 |
| `/stats` | O | O | X |
| `/my-vacations` | O (Enterprise) | O (Enterprise) | X |
| `/dashboard` | X | O | O |
| `/approvals` | X | O | O |
| `/team` | X | X | O |
| `/reports` | X | O | O |
| `/settings` | X | X | O |
| `/vacations` | X | X | O (Enterprise) |
| `/organization` | X | X | O (Standard+) |
| `/policies` | X | X | O (Enterprise) |
| `/analytics` | X | X | O (Enterprise) |

---

## 권한 체크 구현

### 미들웨어 예시

```typescript
// 역할별 접근 가능 경로
const roleRoutes = {
  worker: ['/home', '/sessions', '/stats', '/my-vacations'],
  manager: ['/home', '/sessions', '/stats', '/my-vacations', '/dashboard', '/approvals', '/reports'],
  admin: ['/dashboard', '/approvals', '/team', '/reports', '/settings', '/vacations', '/organization', '/policies', '/analytics'],
};

// 플랜별 제한
const planRoutes = {
  enterprise: ['/my-vacations', '/vacations', '/organization', '/policies', '/analytics'],
};
```

### API 권한 체크 예시

```typescript
// 세션 조회 시
if (user.role === 'worker' || user.role === 'manager') {
  // 본인 세션만
  conditions.push(eq(workSessions.userId, user.id));
} else if (user.role === 'admin') {
  // 회사 전체
  conditions.push(eq(users.companyId, user.companyId));
}
```

---

## 구현 완료 내역

### 페이지 접근 제어
- [x] `/settings` - Admin 전용 체크 추가
- [x] `/team` - Admin 전용 체크 추가
- [x] `/organization` - Admin + Enterprise 전용 체크 추가
- [x] `/policies` - Admin + Enterprise 전용 체크 추가

### Manager 부서 필터링
- [x] `/dashboard` - Manager는 본인 부서 데이터만 표시
- [x] `/approvals` - Manager는 본인 부서원 승인만 표시
- [x] `/reports` - Manager는 지원금 증빙 탭 숨김, 월간 리포트는 부서만

### API 부서 필터링
- [x] `/api/users/[id]` PATCH - Manager는 본인 부서원만 수정 가능
- [x] `/api/vacations` POST - Manager는 본인 부서원 휴가만 대리 신청 가능
- [x] `/api/reports/export` - Manager는 본인 부서 데이터만 내보내기 가능

## TODO

- [ ] 미들웨어에서 역할별 경로 접근 제어 (현재 각 페이지에서 처리)
- [ ] `/sessions/[id]` 상세 페이지 부서 필터링
- [ ] 승인 API (`/api/sessions/[id]/approve`) 부서 필터링
