# Offio 기술 스택

## 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────┐
│                         클라이언트                               │
├──────────────────────┬──────────────────────────────────────────┤
│   데스크톱 앱        │            웹 대시보드                    │
│   (Electron)         │            (Next.js)                     │
│   - Windows/Mac      │            - 근무자용                    │
│   - 기존 개발 완료   │            - 관리자용                    │
└──────────┬───────────┴──────────────────┬───────────────────────┘
           │                              │
           ▼                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        API 서버 (Next.js API Routes)            │
│                        - /api/v1/*                              │
│                        - JWT 인증                               │
└──────────────────────────────┬──────────────────────────────────┘
                               │
           ┌───────────────────┼───────────────────┐
           ▼                   ▼                   ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   PostgreSQL    │  │   AWS S3        │  │   Redis         │
│   (메인 DB)     │  │   (스크린샷)    │  │   (세션/캐시)   │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

---

## 기술 스택

### 프론트엔드 (웹)

| 구분 | 기술 | 선택 이유 |
|------|------|-----------|
| 프레임워크 | **Next.js 14** (App Router) | SSR, API Routes 통합, 빠른 개발 |
| 언어 | **TypeScript** | 타입 안정성, 개발 생산성 |
| 스타일링 | **Tailwind CSS** | 빠른 UI 개발, 일관된 디자인 |
| 데이터 페칭 | **TanStack Query** | 서버 상태 관리, 캐싱 |
| 폼 | **React Hook Form** + **Zod** | 폼 검증, 타입 안전 |
| 차트 | **Recharts** | React 친화적, 간단한 API |
| 날짜 | **date-fns** | 경량, 트리 쉐이킹 지원 |
| UI 컴포넌트 | **shadcn/ui** | 커스터마이징 용이, Tailwind 기반 |

### 백엔드

| 구분 | 기술 | 선택 이유 |
|------|------|-----------|
| 런타임 | **Next.js API Routes** | 프론트와 통합, 배포 단순화 |
| 언어 | **TypeScript** | 풀스택 타입 일관성 |
| ORM | **Drizzle** | 경량, SQL 친화적, Edge 지원 |
| 인증 | **NextAuth.js** + **JWT** | 세션 관리, 데스크톱 앱 지원 |
| 파일 업로드 | **Cloudflare R2** + **Presigned URL** | 대용량 스크린샷 처리, S3 호환 |
| 검증 | **Zod** | 요청/응답 스키마 검증 |

### 데이터베이스

| 구분 | 기술 | 선택 이유 |
|------|------|-----------|
| 메인 DB | **PostgreSQL** | 안정성, JSON 지원, 확장성 |
| 캐시 | **Redis** | 세션 저장, 실시간 현황 캐시 |
| 파일 저장소 | **Cloudflare R2** | 스크린샷 저장, 이그레스 무료 |

### 인프라

| 구분 | 기술 | 선택 이유 |
|------|------|-----------|
| 호스팅 | **Cloudtype** | 국내 서비스, 간편한 배포, 합리적 가격 |
| DB 호스팅 | **Cloudtype PostgreSQL** | 앱과 동일 플랫폼, 관리 편의 |
| 파일 저장 | **Cloudflare R2** | S3 호환, 이그레스 비용 무료 |
| 모니터링 | **Sentry** | 에러 추적, 성능 모니터링 |

### 데스크톱 앱 (기존)

| 구분 | 기술 |
|------|------|
| 프레임워크 | Electron |
| 언어 | TypeScript |
| 기존 백엔드 | Firebase (→ 새 API로 마이그레이션) |

---

## 프로젝트 구조

```
offio/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── (auth)/             # 인증 관련 페이지
│   │   │   ├── login/
│   │   │   └── forgot-password/
│   │   ├── (worker)/           # 근무자 페이지
│   │   │   ├── dashboard/
│   │   │   ├── sessions/
│   │   │   └── stats/
│   │   ├── (admin)/            # 관리자 페이지
│   │   │   ├── dashboard/
│   │   │   ├── approvals/
│   │   │   ├── team/
│   │   │   └── reports/
│   │   └── api/                # API Routes
│   │       └── v1/
│   │           ├── auth/
│   │           ├── desktop/
│   │           ├── worker/
│   │           └── admin/
│   ├── components/             # 공통 컴포넌트
│   │   ├── ui/                 # shadcn/ui 컴포넌트
│   │   ├── layout/             # 레이아웃 컴포넌트
│   │   ├── worker/             # 근무자 전용 컴포넌트
│   │   └── admin/              # 관리자 전용 컴포넌트
│   ├── lib/                    # 유틸리티
│   │   ├── db.ts               # Drizzle 클라이언트
│   │   ├── auth.ts             # 인증 헬퍼
│   │   ├── r2.ts               # R2 업로드
│   │   └── utils.ts            # 공통 유틸
│   ├── db/                     # Drizzle 스키마
│   │   ├── schema.ts           # 테이블 정의
│   │   └── index.ts            # DB export
│   ├── hooks/                  # 커스텀 훅
│   └── types/                  # 타입 정의
├── drizzle/
│   └── migrations/             # 마이그레이션
├── public/                     # 정적 파일
└── tests/                      # 테스트
```

---

## 주요 기술 결정

### 1. Next.js 풀스택

**결정:** 프론트엔드와 백엔드를 Next.js로 통합

**이유:**
- 배포/운영 단순화 (단일 프로젝트)
- API Routes로 충분한 백엔드 기능
- 프론트-백엔드 타입 공유 용이
- Vercel 배포 시 자동 스케일링

**대안 검토:**
- 별도 백엔드 (NestJS, Express) → 관리 복잡도 증가
- tRPC → 데스크톱 앱 호환성 고려하여 REST 선택

### 2. PostgreSQL 선택

**결정:** PostgreSQL (Supabase 또는 AWS RDS)

**이유:**
- 복잡한 쿼리 지원 (리포트, 통계)
- JSON 컬럼으로 유연한 데이터 저장
- Drizzle과 궁합 좋음

**대안 검토:**
- MySQL → PostgreSQL의 JSON 지원이 더 우수
- MongoDB → 관계형 데이터에 RDB가 적합

### 3. 스크린샷 저장 전략

**결정:** Cloudflare R2 + Presigned URL

**흐름:**
```
1. 데스크톱 앱 → API에 업로드 요청
2. API → R2 Presigned URL 발급
3. 데스크톱 앱 → R2에 직접 업로드
4. 완료 후 API에 메타데이터 저장
```

**이유:**
- 서버 부하 감소
- 대용량 파일 안정적 처리
- 이그레스 비용 무료 (S3 대비 비용 절감)
- S3 호환 API (기존 SDK 사용 가능)

### 4. 인증 전략

**결정:** NextAuth.js (웹) + JWT (데스크톱)

**웹:**
- NextAuth.js 세션 기반
- Credentials Provider (이메일/비밀번호)

**데스크톱 앱:**
- JWT 토큰 발급/갱신
- 로컬 저장소에 토큰 저장
- Refresh Token으로 자동 갱신

### 5. 실시간 현황

**결정:** 폴링 + Redis 캐시

**이유:**
- WebSocket은 MVP에서 과도한 복잡도
- 30초 간격 폴링으로 충분
- Redis에 현재 근무 중인 유저 캐시

**추후:**
- Phase 2 이후 WebSocket 고려

---

## 개발 환경

### 필수 도구

```bash
# Node.js 20+
node -v

# pnpm (패키지 매니저)
npm install -g pnpm

# Docker (로컬 DB)
docker --version
```

### 로컬 개발 환경

```bash
# 의존성 설치
pnpm install

# 환경변수 설정
cp .env.example .env.local

# DB 마이그레이션
pnpm drizzle-kit push

# 개발 서버 실행
pnpm dev
```

### 환경 변수

```env
# Database
DATABASE_URL="postgresql://..."

# Auth
NEXTAUTH_SECRET="..."
NEXTAUTH_URL="http://localhost:3000"
JWT_SECRET="..."

# Cloudflare R2
R2_ACCESS_KEY_ID="..."
R2_SECRET_ACCESS_KEY="..."
R2_BUCKET="offio-screenshots"
R2_ENDPOINT="https://<account_id>.r2.cloudflarestorage.com"
R2_PUBLIC_URL="https://screenshots.offio.kr"

# Redis (선택)
REDIS_URL="redis://..."
```

---

## 배포 전략

### 스테이징/프로덕션

| 환경 | 호스팅 | DB | 파일 저장 |
|------|--------|-----|-----------|
| 개발 | localhost | Docker PostgreSQL | 로컬 |
| 스테이징 | Cloudtype (dev) | Cloudtype PostgreSQL | R2 (dev) |
| 프로덕션 | Cloudtype (prod) | Cloudtype PostgreSQL | R2 (prod) |

### CI/CD

```
[GitHub] → [Cloudtype]
   │
   ├─ main 브랜치 → 프로덕션 배포
   └─ develop 브랜치 → 스테이징 배포
```

---

## 보안 고려사항

### 인증/인가

- [ ] 비밀번호 해싱 (bcrypt)
- [ ] JWT 만료 시간 설정 (Access: 1시간, Refresh: 7일)
- [ ] API Rate Limiting
- [ ] CORS 설정

### 데이터 보호

- [ ] 스크린샷 접근 권한 검증 (본인 또는 관리자만)
- [ ] S3 버킷 정책 (Presigned URL만 허용)
- [ ] DB 연결 SSL
- [ ] 민감 정보 환경변수 관리

### 감사

- [ ] API 요청 로깅
- [ ] 주요 액션 감사 로그 (승인/반려 등)

---

## MVP 범위

### Phase 1 (MVP) - Lite + Standard 공통

- [x] Next.js 프로젝트 셋업
- [ ] Drizzle 스키마 (Company, User, WorkSession, ActivityLog, Screenshot)
- [ ] 인증 (NextAuth + JWT)
- [ ] 데스크톱 API (session, activity, screenshot)
- [ ] 근무자 웹 (대시보드, 기록 조회/편집/제출)
- [ ] 관리자 웹 (대시보드, 승인/반려)
- [ ] R2 스크린샷 업로드

### Phase 2 - Standard 차별화

- [ ] 엑셀 다운로드 (xlsx 라이브러리)
- [ ] 지원금 증빙 리포트 PDF

### Phase 3 - Enterprise 기능

- [ ] 부서/조직 관리
- [ ] 근무 정책 설정
- [ ] 휴가 관리
- [ ] 고급 통계 (대시보드 확장)
